<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content="Alberto Huélamo "><meta name=description content="Photo by Markus Spiske in Unsplash
In my company we have a considerably big Scala codebase. We use Scala for data pipelines, function apps, web services&amp;hellip; Everything is based on a common set of libraries that standardizes access to resources, enforces some conventions, and of course provides several utilities. One of this is a tiny little method which implements automatic context/resource management for AutoCloseable objects.
def withCloseable[C &amp;lt;: AutoCloseable, R](closeable: =&amp;gt; C)(f: C =&amp;gt; R): R = { // simplified implementation val result = f(closeable) closeable."><meta name=keywords content=",scala,jvm,functional-programming,learning"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://alhuelamo.com/posts/2022/02/monadic-resource-management-in-scala/><title>Monadic Resource Management in Scala :: Alberto Huélamo</title><link href=https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css rel=stylesheet type=text/css><link rel=stylesheet href=/main.07a619158995ee7162b7e09532f64f2fbebbd7f3c4d2c9c735c59385c318591d.css><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color><link rel="shortcut icon" href=/favicon.ico><meta name=msapplication-TileColor content><meta itemprop=name content="Monadic Resource Management in Scala"><meta itemprop=description content="Photo by Markus Spiske in Unsplash
In my company we have a considerably big Scala codebase. We use Scala for data pipelines, function apps, web services&mldr; Everything is based on a common set of libraries that standardizes access to resources, enforces some conventions, and of course provides several utilities. One of this is a tiny little method which implements automatic context/resource management for AutoCloseable objects.
def withCloseable[C <: AutoCloseable, R](closeable: => C)(f: C => R): R = { // simplified implementation val result = f(closeable) closeable."><meta itemprop=datePublished content="2022-02-14T16:30:00+01:00"><meta itemprop=dateModified content="2022-02-14T16:30:00+01:00"><meta itemprop=wordCount content="1908"><meta itemprop=image content="https://alhuelamo.com/"><meta itemprop=keywords content="scala,jvm,functional-programming,learning,"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://alhuelamo.com/"><meta name=twitter:title content="Monadic Resource Management in Scala"><meta name=twitter:description content="Photo by Markus Spiske in Unsplash
In my company we have a considerably big Scala codebase. We use Scala for data pipelines, function apps, web services&mldr; Everything is based on a common set of libraries that standardizes access to resources, enforces some conventions, and of course provides several utilities. One of this is a tiny little method which implements automatic context/resource management for AutoCloseable objects.
def withCloseable[C <: AutoCloseable, R](closeable: => C)(f: C => R): R = { // simplified implementation val result = f(closeable) closeable."><meta property="og:title" content="Monadic Resource Management in Scala"><meta property="og:description" content="Photo by Markus Spiske in Unsplash
In my company we have a considerably big Scala codebase. We use Scala for data pipelines, function apps, web services&mldr; Everything is based on a common set of libraries that standardizes access to resources, enforces some conventions, and of course provides several utilities. One of this is a tiny little method which implements automatic context/resource management for AutoCloseable objects.
def withCloseable[C <: AutoCloseable, R](closeable: => C)(f: C => R): R = { // simplified implementation val result = f(closeable) closeable."><meta property="og:type" content="article"><meta property="og:url" content="https://alhuelamo.com/posts/2022/02/monadic-resource-management-in-scala/"><meta property="og:image" content="https://alhuelamo.com/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-02-14T16:30:00+01:00"><meta property="article:modified_time" content="2022-02-14T16:30:00+01:00"><meta property="og:site_name" content="Alberto Huélamo"><meta property="article:section" content="code"><meta property="article:published_time" content="2022-02-14 16:30:00 +0100 +0100"></head><body><div class=container><header class=header><span class=header__inner><a href=/ style=text-decoration:none><div class=logo><span class=logo__mark>/</span>
<span class=logo__text>alhuelamo.com</span>
<span class=logo__cursor style=visibility:hidden></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=/about/>About</a></li><li><a href=/posts/>Posts</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class="theme-toggle not-selectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>9 minutes</p></div><article><h1 class=post-title><a href=https://alhuelamo.com/posts/2022/02/monadic-resource-management-in-scala/>Monadic Resource Management in Scala</a></h1><div class=post-content><figure><img src=/img/markus-spiske-C0koz3G1I4I-unsplash.jpg alt="Photo by Markus Spiske in Unsplash"><figcaption><p>Photo by <a href=https://unsplash.com/@markusspiske>Markus Spiske</a> in <a href=https://unsplash.com/s/photos/pieces>Unsplash</a></p></figcaption></figure><p>In my company we have a considerably big Scala codebase. We use Scala for data pipelines, function apps, web services&mldr; Everything is based on a common set of libraries that standardizes access to resources, enforces some conventions, and of course provides several utilities. One of this is a tiny little method which implements automatic context/resource management for <a href=https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/lang/AutoCloseable.html><code>AutoCloseable</code></a> objects.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>def</span> withCloseable<span style=color:#f92672>[</span><span style=color:#66d9ef>C</span> <span style=color:#66d9ef>&lt;:</span> <span style=color:#66d9ef>AutoCloseable</span>, <span style=color:#66d9ef>R</span><span style=color:#f92672>](</span>closeable<span style=color:#66d9ef>:</span> <span style=color:#f92672>=&gt;</span> C<span style=color:#f92672>)(</span>f<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>C</span> <span style=color:#f92672>=&gt;</span> R<span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>R</span> <span style=color:#f92672>=</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// simplified implementation
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>val</span> result <span style=color:#66d9ef>=</span> f<span style=color:#f92672>(</span>closeable<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  closeable<span style=color:#f92672>.</span>close<span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>  result
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>In this post I will explain how I —as a learning exercise— (over)refactored the previous method to make it work with one of Scala&rsquo;s most powerful idioms. A word of warning, this post may be challenging for Scala newbies, but I will include links to the underlying concepts along the text.</p><p>Back to the method, it is quite similar to <a href=https://www.python.org/dev/peps/pep-0343/>Python&rsquo;s <code>with</code> statement</a>: it creates a safe zone in which you can be sure that the resource you&rsquo;re trying to use is going be closed or released whenever the code block finishes.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span>withCloseable<span style=color:#f92672>(</span>openInputStream<span style=color:#f92672>())</span> <span style=color:#f92672>{</span> myInputStream <span style=color:#66d9ef>=&gt;</span>
</span></span><span style=display:flex><span>  myInputStream<span style=color:#f92672>.</span>read<span style=color:#f92672>()</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Here `myInputStream` is *closed*
</span></span></span></code></pre></div><p>By using this method we can forget about closing the resource. It is quite ubiquitous in our codebase, and it&rsquo;s really handy and simple when it&rsquo;s used alone. But, when it comes to composing <code>AutoCloseable</code> resources things get a bit dirtier.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span>withCloseable<span style=color:#f92672>(</span><span style=color:#a6e22e>OauthClient</span><span style=color:#f92672>(</span>conf<span style=color:#f92672>))</span> <span style=color:#f92672>{</span> oauthClient <span style=color:#66d9ef>=&gt;</span>
</span></span><span style=display:flex><span>  withCloseable<span style=color:#f92672>(</span><span style=color:#a6e22e>ServiceClient</span><span style=color:#f92672>(</span>conf<span style=color:#f92672>,</span> oauthClient<span style=color:#f92672>))</span> <span style=color:#f92672>{</span> serviceClient <span style=color:#66d9ef>=&gt;</span>
</span></span><span style=display:flex><span>    withCloseable<span style=color:#f92672>(</span><span style=color:#a6e22e>LoggingClient</span><span style=color:#f92672>(</span>conf<span style=color:#f92672>))</span> <span style=color:#f92672>{</span> loggingClient <span style=color:#66d9ef>=&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Here we have safe access to all three clients.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>This works great too, but it is not quite good-looking, IMHO. It starts resembling <a href=http://callbackhell.com>old JavaScript</a>&mldr; I was thinking on how I could make it look better when I realized Scala has a really nice construction that seemed quite a nice fit for this: <strong>for-comprehensions</strong>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>for</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  oauthClient   <span style=color:#66d9ef>&lt;-</span> withCloseable<span style=color:#f92672>(</span><span style=color:#a6e22e>OauthClient</span><span style=color:#f92672>(</span>conf<span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>  serviceClient <span style=color:#66d9ef>&lt;-</span> withCloseable<span style=color:#f92672>(</span><span style=color:#a6e22e>ServiceClient</span><span style=color:#f92672>(</span>conf<span style=color:#f92672>,</span> oauthClient<span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>  loggingClient <span style=color:#66d9ef>&lt;-</span> withCloseable<span style=color:#f92672>(</span><span style=color:#a6e22e>LoggingClient</span><span style=color:#f92672>(</span>conf<span style=color:#f92672>))</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span> <span style=color:#66d9ef>yield</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Safe access to all three clients
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>This looks more reasonable to my eyes. No more unnecessary indentations and it has a more clear and pleasant look. The problem is we need to do some tweaks before make this work. Also, let&rsquo;s try to make the new API compatible with the previous one.</p><h2 id=how-to-for-comprehend>How to for-comprehend</h2><p>Scala&rsquo;s for-comprehensions are a powerful syntax sugar to compose <a href=https://www.baeldung.com/scala/monads>Monads</a>. I&rsquo;m not going to waste keystrokes explaining <a href=https://stackoverflow.com/questions/44965/what-is-a-monad>what</a> <a href=https://stackoverflow.com/questions/2704652/monad-in-plain-english-for-the-oop-programmer-with-no-fp-background/2704795>Monads</a> <a href="https://www.youtube.com/watch?v=FZAmPhjV11A">are</a> <a href=https://towardsdatascience.com/monads-from-the-lens-of-imperative-programmer-af1ab8c8790c>in</a> <a href=https://medium.com/att-israel/its-time-you-learn-about-monads-4ebe687e3ec7>detail</a>, but for the purposes of this post, you just <em>basically</em> need to take into account that arrows <code>&lt;-</code> in a for-comprehension are nothing else than calls to the <code>flatMap</code> method of a given object, and that the <code>flatMap</code> method is the cornerstone of Monads.</p><p>In <em>regular</em> syntax the previous snipped would look like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#75715e>// Warning: this code does not compile yet!
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>withCloseable<span style=color:#f92672>(</span><span style=color:#a6e22e>OauthClient</span><span style=color:#f92672>(</span>conf<span style=color:#f92672>)).</span>flatMap <span style=color:#f92672>{</span> oauthClient <span style=color:#66d9ef>=&gt;</span>
</span></span><span style=display:flex><span>  withCloseable<span style=color:#f92672>(</span><span style=color:#a6e22e>ServiceClient</span><span style=color:#f92672>(</span>conf<span style=color:#f92672>,</span> oauthClient<span style=color:#f92672>)).</span>flatMap <span style=color:#f92672>{</span> serviceClient <span style=color:#66d9ef>=&gt;</span>
</span></span><span style=display:flex><span>    withCloseable<span style=color:#f92672>(</span><span style=color:#a6e22e>LoggingClient</span><span style=color:#f92672>(</span>conf<span style=color:#f92672>)).</span>map <span style=color:#f92672>{</span> loggingClient <span style=color:#66d9ef>=&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Safe access to all three clients
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>As you can see, by using the regular style we end up with code similar to the original. We can see calling <code>withCloseable()</code> should return some kind of <strong>underlying type</strong> which implements the <code>flatMap</code> method. The <code>map</code> method is also needed, but it can be implemented in terms of <code>flatMap</code>. Let&rsquo;s see how we can achieve this.</p><h2 id=introducing-openedresource>Introducing OpenedResource</h2><p>Let&rsquo;s analyze <code>withCloseable</code>&rsquo;s original signature:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>def</span> withCloseable<span style=color:#f92672>[</span><span style=color:#66d9ef>C</span> <span style=color:#66d9ef>&lt;:</span> <span style=color:#66d9ef>AutoCloseable</span>, <span style=color:#66d9ef>R</span><span style=color:#f92672>](</span>closeable<span style=color:#66d9ef>:</span> <span style=color:#f92672>=&gt;</span> C<span style=color:#f92672>)(</span>f<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>C</span> <span style=color:#f92672>=&gt;</span> R<span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>R</span>
</span></span></code></pre></div><p>It takes two argument lists. The first one receives the <code>AutoCloseable</code> instance <a href=https://docs.scala-lang.org/tour/by-name-parameters.html>lazily</a>. The second one is the actual <em>safe zone</em> where we have access to our <code>AutoCloseable</code> object, which can also be written as a code block (see previous code snippets). We&rsquo;ve seen though that the <code>flatMap</code> method should be available <em>right after</em> the first argument list. So calling <code>withCloseable</code> with only the first argument list should return our underlying data structure: <code>OpenedResource</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>def</span> withCloseable<span style=color:#f92672>[</span><span style=color:#66d9ef>C</span> <span style=color:#66d9ef>&lt;:</span> <span style=color:#66d9ef>AutoCloseable</span><span style=color:#f92672>](</span>closeable<span style=color:#66d9ef>:</span> <span style=color:#f92672>=&gt;</span> C<span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>OpenedResource</span><span style=color:#f92672>[</span><span style=color:#66d9ef>C</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>=</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>OpenedResource</span><span style=color:#f92672>(</span>closeable<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>OpenedResource</span><span style=color:#f92672>[</span><span style=color:#66d9ef>C</span> <span style=color:#66d9ef>&lt;:</span> <span style=color:#66d9ef>AutoCloseable</span><span style=color:#f92672>](</span>closeable<span style=color:#66d9ef>:</span> <span style=color:#f92672>=&gt;</span> C<span style=color:#f92672>)</span> 
</span></span></code></pre></div><p>What about <code>withCloseable</code>&rsquo;s second argument list? If we want to replicate it in <code>OpenedResource</code> we need its instances to be callable, i.e. we need the <a href=https://blog.matthewrathbone.com/2017/03/06/scala-object-apply-functions.html><code>apply</code></a> method.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>OpenedResource</span><span style=color:#f92672>[</span><span style=color:#66d9ef>C</span> <span style=color:#66d9ef>&lt;:</span> <span style=color:#66d9ef>AutoCloseable</span><span style=color:#f92672>](</span>closeable<span style=color:#66d9ef>:</span> <span style=color:#f92672>=&gt;</span> C<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> apply<span style=color:#f92672>[</span><span style=color:#66d9ef>R</span><span style=color:#f92672>](</span>f<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>C</span> <span style=color:#f92672>=&gt;</span> R<span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>R</span> <span style=color:#f92672>=</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// simplified implementation
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>val</span> result <span style=color:#66d9ef>=</span> f<span style=color:#f92672>(</span>closeable<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    closeable<span style=color:#f92672>.</span>close<span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>    result
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>Here we essentially moved the second argument list of the original <code>withCloseable</code> method into its own wrapper type. In other words, <code>OpenedResource</code> is the representation of the <em>safe zone</em> for a closeable instance.</p><h2 id=composing-openedresource>Composing OpenedResource</h2><p>As said, for-comprehensions are allowed in Scala for types that implement <code>flatMap</code> and <code>map</code> methods. They are both higher-order functions (HOF) that allow composition and transformations of the underlying values of the monad/wrapper object. And both they always have the very same signatures on every type they are implemented on.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>OpenedResource</span><span style=color:#f92672>[</span><span style=color:#66d9ef>C</span><span style=color:#f92672>](</span>closeable<span style=color:#66d9ef>:</span> <span style=color:#f92672>=&gt;</span> C<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> apply<span style=color:#f92672>[</span><span style=color:#66d9ef>R</span><span style=color:#f92672>](</span>f<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>C</span> <span style=color:#f92672>=&gt;</span> R<span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>R</span> <span style=color:#f92672>=</span> <span style=color:#75715e>// omitted code
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> flatMap<span style=color:#f92672>[</span><span style=color:#66d9ef>B</span> <span style=color:#66d9ef>&lt;:</span> <span style=color:#66d9ef>AutoCloseable</span><span style=color:#f92672>](</span>f<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>C</span> <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>OpenedResource</span><span style=color:#f92672>[</span><span style=color:#66d9ef>B</span><span style=color:#f92672>])</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>OpenedResource</span><span style=color:#f92672>[</span><span style=color:#66d9ef>B</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>=</span> <span style=color:#f92672>???</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> map<span style=color:#f92672>[</span><span style=color:#66d9ef>B</span> <span style=color:#66d9ef>&lt;:</span> <span style=color:#66d9ef>AutoCloseable</span><span style=color:#f92672>](</span>f<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>C</span> <span style=color:#f92672>=&gt;</span> B<span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>OpenedResource</span><span style=color:#f92672>[</span><span style=color:#66d9ef>B</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>=</span> <span style=color:#f92672>???</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>In the context of <code>OpenedResource</code>, <code>flatMap</code> should provide <em>safe</em> access to the underlying <code>AutoCloseable</code> resource. Wait a second, this is precisely what the <code>apply</code> method does! We can use it to implement <code>flatMap</code>!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>def</span> flatMap<span style=color:#f92672>[</span><span style=color:#66d9ef>B</span> <span style=color:#66d9ef>&lt;:</span> <span style=color:#66d9ef>AutoCloseable</span><span style=color:#f92672>](</span>f<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>C</span> <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>OpenedResource</span><span style=color:#f92672>[</span><span style=color:#66d9ef>B</span><span style=color:#f92672>])</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>OpenedResource</span><span style=color:#f92672>[</span><span style=color:#66d9ef>B</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>=</span> 
</span></span><span style=display:flex><span>  apply<span style=color:#f92672>(</span>f<span style=color:#f92672>)</span>
</span></span></code></pre></div><p>The only nuance here is that the <code>apply</code> call would is forced to return an <code>OpenedResource</code> instance, which is the return type of <code>f</code>, but that is exactly what we want. And now that we have <code>flatMap</code> we can use it to implement <code>map</code> by just making the compiler happy.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>def</span> map<span style=color:#f92672>[</span><span style=color:#66d9ef>B</span> <span style=color:#66d9ef>&lt;:</span> <span style=color:#66d9ef>AutoCloseable</span><span style=color:#f92672>](</span>f<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>C</span> <span style=color:#f92672>=&gt;</span> B<span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>OpenedResource</span><span style=color:#f92672>[</span><span style=color:#66d9ef>B</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>=</span>
</span></span><span style=display:flex><span>  flatMap<span style=color:#f92672>(</span>c <span style=color:#66d9ef>=&gt;</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>OpenedResource</span><span style=color:#f92672>(</span>f<span style=color:#f92672>(</span>c<span style=color:#f92672>)))</span>
</span></span></code></pre></div><h2 id=testing-time>Testing time!</h2><p>Let&rsquo;s write a unit test to verify it works.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#e6db74>&#34;withCloseable allow for-comprehensions&#34;</span> in <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>val</span> closeRecords <span style=color:#66d9ef>=</span> mutable<span style=color:#f92672>.</span><span style=color:#a6e22e>MutableList</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Int</span><span style=color:#f92672>]()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyResource</span><span style=color:#f92672>(</span><span style=color:#66d9ef>val</span> n<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Int</span><span style=color:#f92672>)</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>AutoCloseable</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>def</span> close<span style=color:#f92672>()</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Unit</span> <span style=color:#f92672>=</span> closeRecords <span style=color:#f92672>+=</span> n
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>val</span> result<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>OpenedResource</span><span style=color:#f92672>[</span><span style=color:#66d9ef>MyResource</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>=</span> <span style=color:#66d9ef>for</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    i1 <span style=color:#66d9ef>&lt;-</span> withCloseable<span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> <span style=color:#a6e22e>MyResource</span><span style=color:#f92672>(</span><span style=color:#ae81ff>1</span><span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>    i2 <span style=color:#66d9ef>&lt;-</span> withCloseable<span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> <span style=color:#a6e22e>MyResource</span><span style=color:#f92672>(</span><span style=color:#ae81ff>2</span><span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span> <span style=color:#66d9ef>yield</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// safe zone with access to both closeable resources
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>MyResource</span><span style=color:#f92672>(</span>i1<span style=color:#f92672>.</span>n <span style=color:#f92672>+</span> i2<span style=color:#f92672>.</span>n<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  closeRecords<span style=color:#f92672>.</span>toList should contain theSameElementsAs <span style=color:#a6e22e>List</span><span style=color:#f92672>(</span><span style=color:#ae81ff>2</span><span style=color:#f92672>,</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>This test is very simple: we define an <code>AutoCloseable</code> child class which appends a value in a list whenever its <code>close</code> method is called. The expected result is that the latest call to <code>withCloseable</code> will release the resource first, and thus that is why the expected list is in the reversed order of calls to <code>withCloseable</code>.</p><p>This test works! But notice there is a quite important nuance: the <code>result</code> type is <code>OpenedResource[MyResource]</code>! This is inconvenient:</p><ul><li><strong>Our</strong> <code>flatMap</code> method ensures <code>AutoCloseable</code> composition by enforcing its return type to be an extension of <code>AutoCloseable</code>. In other words, in the <code>yield</code> block we cannot return any other type than <code>AutoCloseable</code> instances.</li><li>We need a way to access or unwrap <code>OpenedResource</code>&rsquo;s underlying value.</li></ul><p>Let&rsquo;s focus on the first point. This code</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>val</span> result<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>OpenedResource</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Int</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>=</span> <span style=color:#66d9ef>for</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  i1 <span style=color:#66d9ef>&lt;-</span> withCloseable<span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> <span style=color:#a6e22e>MyResource</span><span style=color:#f92672>(</span><span style=color:#ae81ff>1</span><span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>  i2 <span style=color:#66d9ef>&lt;-</span> withCloseable<span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> <span style=color:#a6e22e>MyResource</span><span style=color:#f92672>(</span><span style=color:#ae81ff>2</span><span style=color:#f92672>))</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span> <span style=color:#66d9ef>yield</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  i1<span style=color:#f92672>.</span>n <span style=color:#f92672>+</span> i2<span style=color:#f92672>.</span>n
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>won&rsquo;t compile since <code>Int</code> —the value of the type we are returning in the <code>yield</code> section— does not extend <code>AutoCloseable</code>.</p><p>One option could be wrapping our types in a fake <code>AutoCloseable</code> class with a <code>fake</code> close method, but that would make the whole thing extremely inconvenient.</p><p>Could we perhaps just remove type bounds in <code>OpenedResource</code>&rsquo;s definition? That would make the test compile but the internals of <code>OpenedResource</code> won&rsquo;t, since the compiler is not aware that the value it&rsquo;s wrapping has a <code>close</code> method.</p><p>What if we had some way to tell the compiler to derive a type that provides the resource-releasing API —the <code>close</code> method— for <code>AutoCloseable</code> types and yet allow regular types to fit in so they can be the result of a for-comprehension?</p><h2 id=enter-type-classes>Enter type classes</h2><p>Well, it turns out we have a way. <a href=https://www.baeldung.com/scala/type-classes>Type classes</a> can isolate the resource-releasing logic from the types we pass to <code>OpenedResource</code> and thus make it generic for any type.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>trait</span> <span style=color:#a6e22e>Closer</span><span style=color:#f92672>[</span><span style=color:#66d9ef>C</span><span style=color:#f92672>]</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> close<span style=color:#f92672>(</span>closeable<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>C</span><span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Unit</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>First thing to define on a type class is the type class interface. Our use case is quite simple. We need an interface to <code>close</code> resources.</p><p>Let&rsquo;s refactor our <code>OpenedResource</code> class.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>OpenedResource</span><span style=color:#f92672>[</span><span style=color:#66d9ef>C</span><span style=color:#f92672>](</span>closeable<span style=color:#66d9ef>:</span> <span style=color:#f92672>=&gt;</span> C<span style=color:#f92672>)(</span><span style=color:#66d9ef>implicit</span> closer<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Closer</span><span style=color:#f92672>[</span><span style=color:#66d9ef>C</span><span style=color:#f92672>])</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> apply<span style=color:#f92672>[</span><span style=color:#66d9ef>R</span><span style=color:#f92672>](</span>f<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>C</span> <span style=color:#f92672>=&gt;</span> R<span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>R</span> <span style=color:#f92672>=</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>val</span> result <span style=color:#66d9ef>=</span> f<span style=color:#f92672>(</span>closeable<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    closer<span style=color:#f92672>.</span>close<span style=color:#f92672>(</span>closeable<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    result
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> flatMap<span style=color:#f92672>[</span><span style=color:#66d9ef>B:</span> <span style=color:#66d9ef>Closer</span><span style=color:#f92672>](</span>f<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>C</span> <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>OpenedResource</span><span style=color:#f92672>[</span><span style=color:#66d9ef>B</span><span style=color:#f92672>])</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>OpenedResource</span><span style=color:#f92672>[</span><span style=color:#66d9ef>B</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>=</span> apply<span style=color:#f92672>(</span>f<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> map<span style=color:#f92672>[</span><span style=color:#66d9ef>B:</span> <span style=color:#66d9ef>Closer</span><span style=color:#f92672>](</span>f<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>C</span> <span style=color:#f92672>=&gt;</span> B<span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>OpenedResource</span><span style=color:#f92672>[</span><span style=color:#66d9ef>B</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>=</span> flatMap<span style=color:#f92672>(</span>c <span style=color:#66d9ef>=&gt;</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>OpenedResource</span><span style=color:#f92672>(</span>f<span style=color:#f92672>(</span>c<span style=color:#f92672>)))</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>Instead of enforcing <code>C</code> to be <code>AutoCloseable</code>, we take that logic out to a <code>Closer[C]</code> instance, and then we use that instance to free the resource. We also use <a href=https://docs.scala-lang.org/scala3/book/ca-context-bounds.html>context bounds</a> in <code>flatMap</code> and <code>map</code> so that we make sure that the return type also has a <code>Closer</code> instance available.</p><p>But, where are those <code>Closer</code> (type class) instances? Well, we can provide them automagically using <code>implicits</code> or <code>given</code>/<code>using</code> in Scala 3.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>object</span> <span style=color:#a6e22e>Closer</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>implicit</span> <span style=color:#66d9ef>def</span> autoCloseableCloser<span style=color:#f92672>[</span><span style=color:#66d9ef>C</span> <span style=color:#66d9ef>&lt;:</span> <span style=color:#66d9ef>AutoCloseable</span><span style=color:#f92672>]</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Closer</span><span style=color:#f92672>[</span><span style=color:#66d9ef>C</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Closer</span><span style=color:#f92672>[</span><span style=color:#66d9ef>C</span><span style=color:#f92672>]</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>def</span> close<span style=color:#f92672>(</span>closeable<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>C</span><span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Unit</span> <span style=color:#f92672>=</span> closeable<span style=color:#f92672>.</span>close<span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>implicit</span> <span style=color:#66d9ef>def</span> nonAutoCloseable<span style=color:#f92672>[</span><span style=color:#66d9ef>T</span><span style=color:#f92672>]</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Closer</span><span style=color:#f92672>[</span><span style=color:#66d9ef>T</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Closer</span><span style=color:#f92672>[</span><span style=color:#66d9ef>T</span><span style=color:#f92672>]</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>def</span> close<span style=color:#f92672>(</span>closeable<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>T</span><span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Unit</span> <span style=color:#f92672>=</span> <span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>Here we declare two <code>Closer</code> instances. One for <code>AutoCloseable</code> types and another generic one for the rest of types. If we create an <code>OpenedResource</code> instance with an <code>AutoCloseable</code> argument, the compiler will inject <code>autoCloseableCloser</code>, whereas it will inject <code>nonAutoCloseable</code> for any other type. This last one implements a fake <code>close</code> method by just returning <code>Unit</code>; but it works for any type and we do not need to write it anywhere else!</p><p>If we get back to our test, now we can do the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#e6db74>&#34;withCloseable allow for-comprehensions&#34;</span> in <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>val</span> closeRecords <span style=color:#66d9ef>=</span> mutable<span style=color:#f92672>.</span><span style=color:#a6e22e>MutableList</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Int</span><span style=color:#f92672>]()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyAutoCloseable</span><span style=color:#f92672>(</span><span style=color:#66d9ef>val</span> n<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Int</span><span style=color:#f92672>)</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>AutoCloseable</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>def</span> close<span style=color:#f92672>()</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Unit</span> <span style=color:#f92672>=</span> closeRecords <span style=color:#f92672>+=</span> n
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>val</span> result<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>OpenedResource</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Int</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>=</span> <span style=color:#66d9ef>for</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    i1 <span style=color:#66d9ef>&lt;-</span> withCloseable<span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> <span style=color:#a6e22e>MyAutoCloseable</span><span style=color:#f92672>(</span><span style=color:#ae81ff>1</span><span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>    i2 <span style=color:#66d9ef>&lt;-</span> withCloseable<span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> <span style=color:#a6e22e>MyAutoCloseable</span><span style=color:#f92672>(</span><span style=color:#ae81ff>2</span><span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span> <span style=color:#66d9ef>yield</span> i1<span style=color:#f92672>.</span>n <span style=color:#f92672>+</span> i2<span style=color:#f92672>.</span>n
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  closeRecords<span style=color:#f92672>.</span>toList should contain theSameElementsAs <span style=color:#a6e22e>List</span><span style=color:#f92672>(</span><span style=color:#ae81ff>2</span><span style=color:#f92672>,</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>And this code compiles! Whenever <code>withCloseable</code> creates <code>OpenedResource</code> instances the compiler will inject <code>autoCloseableCloser</code> because the argument we are passing to <code>withCloseable</code> is an <code>AutoCloseable</code> instance!</p><p>Also, notice we are now allowed to get an <code>OpenedResource[Int]</code> instance as the result of the for-comprehension.</p><h2 id=unwrapping-the-result>Unwrapping the result</h2><p>Well, there was a second nuance we did not addressed. How do we unwrap that <code>Int</code> in the test <code>result</code>? That&rsquo;s fairly trivial:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>OpenedResource</span><span style=color:#f92672>[</span><span style=color:#66d9ef>C</span><span style=color:#f92672>](</span>closeable<span style=color:#66d9ef>:</span> <span style=color:#f92672>=&gt;</span> C<span style=color:#f92672>)(</span><span style=color:#66d9ef>implicit</span> closer<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Closer</span><span style=color:#f92672>[</span><span style=color:#66d9ef>C</span><span style=color:#f92672>])</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// code omitted
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> get<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>C</span> <span style=color:#f92672>=</span> apply<span style=color:#f92672>(</span>identity<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>Here we added the <code>get</code> method to obtain the wrapped value in <code>OpenedResource</code> and also make sure we release the resource in the case it&rsquo;s actually a releasable object. We just use the <code>identity</code> function on <code>apply</code> —remember, <code>apply</code> runs the function it receives and after that it <code>closes</code> the resource.</p><h2 id=proper-alternatives-to-resource-management>(Proper) alternatives to resource management</h2><p>This post was the story of how I over-engineered a solution for a first-world problem™ just for fun and for the sake of learning and understanding how to leverage Scala&rsquo;s idioms. The original API is more than fine: it just works and it&rsquo;s way simpler, and thus easier to maintain. That would be enough to discard my approach. Suffice to say, this did not make it into production :) Still, I enjoyed myself writing it, and it was a very nice learning exercise.</p><p>There are proper and nicer existing alternatives to resource management, like Scala 2.13&rsquo;s <a href=https://www.scala-lang.org/api/2.13.6/scala/util/Using$.html><code>Using</code></a>, or Cats Effect&rsquo;s <a href=https://typelevel.org/cats-effect/docs/std/resource><code>Resource</code></a>.</p><p>We engineers like to reinvent the wheel where most probably others made nicer wheels, but it is still a worthy exercise for ourselves, because we can learn a lot in the process.</p></div></article><hr><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://alhuelamo.com/tags/scala/>scala</a></span>
<span class=tag><a href=https://alhuelamo.com/tags/jvm/>jvm</a></span>
<span class=tag><a href=https://alhuelamo.com/tags/functional-programming/>functional-programming</a></span>
<span class=tag><a href=https://alhuelamo.com/tags/learning/>learning</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-folder meta-icon"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg><span class=tag><a href=https://alhuelamo.com/categories/code/>code</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>1908 Words</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>2022-02-14</p></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://alhuelamo.com/posts/2024/02/the-indirect-argument-in-pytest-fixture-parametrization/><span class=button__icon>←</span>
<span class=button__text>The 'indirect' argument in pytest fixture parametrization</span></a></span>
<span class="button next"><a href=https://alhuelamo.com/posts/2021/11/native-apple-silicon-jdks/><span class=button__text>Native Apple Silicon JDKs</span>
<span class=button__icon>→</span></a></span></div></div></main></div><footer class=footer><div class=footer__inner><div class=footer__content><span>© Alberto Huélamo</span><span><a href=http://github.com/alhuelamo>github</a></span><span><a rel=me href=https://mastodon.social/@alhuelamo>mastodon</a></span><span><a href=http://twitter.com/alhuelamo>twitter</a></span><span><a href=https://www.linkedin.com/in/alhuelamo/>linkedin</a></span></div></div><div class=footer__inner><div class=footer__content><span>Powered by <a href=http://gohugo.io>Hugo</a></span><span>Theme by <a href=https://github.com/rhazdon>Djordje Atlialp</a></span></div></div></footer></div><script type=text/javascript src=/bundle.min.d77d5084308ac828356fa99258c7bb2b883864daec9a1d6fda72ee42302b263896d364795501c9f99f6e900fcc776d90493fab956d479cfbaff28decbaf8f095.js integrity="sha512-131QhDCKyCg1b6mSWMe7K4g4ZNrsmh1v2nLuQjArJjiW02R5VQHJ+Z9ukA/Md22QST+rlW1HnPuv8o3suvjwlQ=="></script></body></html>